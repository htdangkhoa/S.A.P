{"version":3,"file":"mpeg.js","sourceRoot":"","sources":["../../src/mpeg.ts"],"names":[],"mappings":"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AE,EAAC;QACtD,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAC;QACvD,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAC;QACvD,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAC;QACvD,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAC;QACzD,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAC;QAC1D,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAC;QAC1D,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAE,EAAC;QAC1D,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAC;QAC5D,IAAI,EAAE,EAAC,EAAE,EAAE,GAAG,EAAE,EAAE,EAAE,GAAG,EAAE,EAA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","sourcesContent":["'use strict';\r\n\r\nimport ReadableStream = NodeJS.ReadableStream;\r\nimport * as strtok from 'strtok2';\r\nimport {Token} from 'strtok2';\r\nimport common from './common';\r\nimport {Done, GetFileSize, IStreamParser, TagCallback} from './parser';\r\n\r\nenum State {\r\n  mpegSearchSync1 = 1,\r\n  mpegSearchSync2 = 2,\r\n  audio_frame_header = 3,\r\n  CRC = 4,\r\n  side_information = 5,\r\n  xtra_info_header = 6,\r\n  skip_frame_data = 7\r\n}\r\n\r\n/**\r\n * MPEG Audio Layer I/II/III frame header\r\n * Ref: https://www.mp3-tech.org/programmer/frame_header.html\r\n * Bit layout: AAAAAAAA AAABBCCD EEEEFFGH IIJJKLMM\r\n */\r\nclass MpegFrameHeader {\r\n\r\n  public static SyncByte1 = 0xFF;\r\n  public static SyncByte2 = 0xE0;\r\n\r\n  public static VersionID = [2.5, null, 2, 1];\r\n  public static LayerDescription = [null, 3, 2, 1];\r\n  public static ChannelMode = ['stereo', 'joint_stereo', 'dual_channel', 'mono'];\r\n\r\n  private static bitrate_index = {\r\n    0x01: {11: 32, 12: 32, 13: 32, 21: 32, 22: 8, 23: 8},\r\n    0x02: {11: 64, 12: 48, 13: 40, 21: 48, 22: 16, 23: 16},\r\n    0x03: {11: 96, 12: 56, 13: 48, 21: 56, 22: 24, 23: 24},\r\n    0x04: {11: 128, 12: 64, 13: 56, 21: 64, 22: 32, 23: 32},\r\n    0x05: {11: 160, 12: 80, 13: 64, 21: 80, 22: 40, 23: 40},\r\n    0x06: {11: 192, 12: 96, 13: 80, 21: 96, 22: 48, 23: 48},\r\n    0x07: {11: 224, 12: 112, 13: 96, 21: 112, 22: 56, 23: 56},\r\n    0x08: {11: 256, 12: 128, 13: 112, 21: 128, 22: 64, 23: 64},\r\n    0x09: {11: 288, 12: 160, 13: 128, 21: 144, 22: 80, 23: 80},\r\n    0x0A: {11: 320, 12: 192, 13: 160, 21: 160, 22: 96, 23: 96},\r\n    0x0B: {11: 352, 12: 224, 13: 192, 21: 176, 22: 112, 23: 112},\r\n    0x0C: {11: 384, 12: 256, 13: 224, 21: 192, 22: 128, 23: 128},\r\n    0x0D: {11: 416, 12: 320, 13: 256, 21: 224, 22: 144, 23: 144},\r\n    0x0E: {11: 448, 12: 384, 13: 320, 21: 256, 22: 160, 23: 160}\r\n  };\r\n\r\n  private static sampling_rate_freq_index = {\r\n    1: {0x00: 44100, 0x01: 48000, 0x02: 32000},\r\n    2: {0x00: 22050, 0x01: 24000, 0x02: 16000},\r\n    2.5: {0x00: 11025, 0x01: 12000, 0x02: 8000}\r\n  };\r\n\r\n  // B(20,19): MPEG Audio versionIndex ID\r\n  public versionIndex: number;\r\n  // C(18,17): Layer description\r\n  public layerIndex: number;\r\n  // D(16): Protection bit\r\n  public isProtectedByCRC: boolean;\r\n  // E(15,12): Bitrate index\r\n  public bitrateIndex: number;\r\n  // F(11,10): Sampling rate frequency index\r\n  public sampRateFreqIndex: number;\r\n  // G(9): Padding bit\r\n  public padding: boolean;\r\n  // H(8): Private bit\r\n  public privateBit: boolean;\r\n  // I(7,6): Channel Mode\r\n  public channelModeIndex: number;\r\n  // J(5,4): Mode extension (Only used in Joint stereo)\r\n  public modeExtension: number;\r\n  // K(3): Copyright\r\n  public isCopyrighted: boolean;\r\n  // L(2): Original\r\n  public isOriginalMedia: boolean;\r\n  // M(3): The original bit indicates, if it is set, that the frame is located on its original media.\r\n  public emphasis: number;\r\n\r\n  public layer: number;\r\n  public version: number;\r\n  public channelMode: string;\r\n  public bitrate: number;\r\n  public samplingRate: number;\r\n\r\n  public constructor(buf, off) {\r\n    // B(20,19): MPEG Audio versionIndex ID\r\n    this.versionIndex = common.getBitAllignedNumber(buf, off + 1, 3, 2);\r\n    // C(18,17): Layer description\r\n    this.layer = MpegFrameHeader.LayerDescription[common.getBitAllignedNumber(buf, off + 1, 5, 2)];\r\n    // D(16): Protection bit (if true 16-bit CRC follows header)\r\n    this.isProtectedByCRC = !common.isBitSet(buf, off + 1, 7);\r\n    // E(15,12): Bitrate index\r\n    this.bitrateIndex = common.getBitAllignedNumber(buf, off + 2, 0, 4);\r\n    // F(11,10): Sampling rate frequency index\r\n    this.sampRateFreqIndex = common.getBitAllignedNumber(buf, off + 2, 4, 2);\r\n    // G(9): Padding bit\r\n    this.padding = common.isBitSet(buf, off + 2, 6);\r\n    // H(8): Private bit\r\n    this.privateBit = common.isBitSet(buf, off + 2, 7);\r\n    // I(7,6): Channel Mode\r\n    this.channelModeIndex = common.getBitAllignedNumber(buf, off + 3, 0, 2);\r\n    // J(5,4): Mode extension (Only used in Joint stereo)\r\n    this.modeExtension = common.getBitAllignedNumber(buf, off + 3, 2, 2);\r\n    // K(3): Copyright\r\n    this.isCopyrighted = common.isBitSet(buf, off + 3, 4);\r\n    // L(2): Original\r\n    this.isOriginalMedia = common.isBitSet(buf, off + 3, 5);\r\n    // M(3): The original bit indicates, if it is set, that the frame is located on its original media.\r\n    this.emphasis = common.getBitAllignedNumber(buf, off + 3, 7, 2);\r\n\r\n    this.version = MpegFrameHeader.VersionID[this.versionIndex];\r\n    if (this.version === null)\r\n      throw new Error('Invalid MPEG Audio version');\r\n\r\n    this.channelMode = MpegFrameHeader.ChannelMode[this.channelModeIndex];\r\n    this.samplingRate = this.calcSamplingRate();\r\n\r\n    let bitrateInKbps = this.calcBitrate();\r\n    this.bitrate = bitrateInKbps == null ? null : bitrateInKbps * 1000;\r\n    this.samplingRate = this.calcSamplingRate();\r\n  }\r\n\r\n  public calcDuration(numFrames): number {\r\n    return Math.round(numFrames * (this.calcSamplesPerFrame() / this.samplingRate));\r\n  }\r\n\r\n  public calcSamplesPerFrame(): number {\r\n    if (this.layer === 1) return 384;\r\n    if (this.layer === 2) return 1152;\r\n    if (this.layer === 3 && this.version === 1) return 1152;\r\n    if (this.layer === 3 && (this.version === 2 || this.version === 2.5)) return 576;\r\n  }\r\n\r\n  public calculateSideInfoLength(): number {\r\n    if (this.layer !== 3) return 2;\r\n    if (this.channelModeIndex === 3) {\r\n      // mono\r\n      if (this.version === 1) {\r\n        return 17;\r\n      } else if (this.version === 2 || this.version === 2.5) {\r\n        return 9;\r\n      }\r\n    } else {\r\n      if (this.version === 1) {\r\n        return 32;\r\n      } else if (this.version === 2 || this.version === 2.5) {\r\n        return 17;\r\n      }\r\n    }\r\n  }\r\n\r\n  public calcSlotSize(): number {\r\n    return [null, 4, 1, 1][this.layer];\r\n  }\r\n\r\n  private calcBitrate(): number {\r\n    if (this.bitrateIndex === 0x00) return null; // free\r\n    if (this.bitrateIndex === 0x0F) return null; // 'reserved'\r\n    let mpegVersion: string = this.version.toString() + this.layer;\r\n    return MpegFrameHeader.bitrate_index[this.bitrateIndex][mpegVersion];\r\n  }\r\n\r\n  private calcSamplingRate(): number {\r\n    if (this.sampRateFreqIndex === 0x03) return null; // 'reserved'\r\n    return MpegFrameHeader.sampling_rate_freq_index[this.version][this.sampRateFreqIndex];\r\n  }\r\n}\r\n\r\n/**\r\n * MPEG Audio Layer I/II/III\r\n */\r\nclass MpegAudioLayer {\r\n\r\n  public static FrameHeader = {\r\n    len: 4,\r\n\r\n    get: (buf, off): MpegFrameHeader => {\r\n      return new MpegFrameHeader(buf, off);\r\n    }\r\n  };\r\n\r\n  /**\r\n   * Info Tag\r\n   * Ref: http://gabriel.mp3-tech.org/mp3infotag.html\r\n   */\r\n  public static InfoTag = {\r\n    len: 140,\r\n\r\n    get: (buf, off) => {\r\n      return {\r\n        // 4 bytes for Header Tag\r\n        headerTag: new strtok.StringType(4, 'ascii').get(buf, off),\r\n        // 4 bytes for HeaderFlags\r\n        headerFlags: new strtok.BufferType(4).get(buf, off + 4),\r\n\r\n        // 100 bytes for entry (NUMTOCENTRIES)\r\n        // numToCentries: new strtok.BufferType(100).get(buf, off + 8),\r\n        // FRAME SIZE\r\n        // frameSize: strtok.UINT32_BE.get(buf, off + 108),\r\n\r\n        numFrames: strtok.UINT32_BE.get(buf, off + 8),\r\n\r\n        numToCentries: new strtok.BufferType(100).get(buf, off + 108),\r\n\r\n        // the number of header APE_HEADER bytes\r\n        streamSize: strtok.UINT32_BE.get(buf, off + 112),\r\n        // the number of header data bytes (from original file)\r\n        vbrScale: strtok.UINT32_BE.get(buf, off + 116),\r\n\r\n        /**\r\n         * LAME Tag, extends the Xing header format\r\n         * First added in LAME 3.12 for VBR\r\n         * The modified header is also included in CBR files (effective LAME 3.94), with \"Info\" instead of \"XING\" near the beginning.\r\n         */\r\n\r\n        //  Initial LAME info, e.g.: LAME3.99r\r\n        encoder: new strtok.StringType(9, 'ascii').get(buf, off + 120),\r\n        //  Info Tag\r\n        infoTag: strtok.UINT8.get(buf, off + 129) >> 4,\r\n        // VBR method\r\n        vbrMethod: strtok.UINT8.get(buf, off + 129) & 0xf\r\n      };\r\n    }\r\n  };\r\n\r\n  public static getVbrCodecProfile(vbrScale: number): string {\r\n    return 'V' + (100 - vbrScale) / 10;\r\n  }\r\n}\r\n\r\nexport class MpegParser implements IStreamParser {\r\n\r\n  private headerSize: number;\r\n\r\n  private frameCount: number = 0;\r\n  private state: State;\r\n\r\n  private audioFrameHeader;\r\n  private bitrates: number[] = [];\r\n  private offset: number;\r\n  private frame_size;\r\n  private crc: number;\r\n\r\n  private stream: NodeJS.ReadableStream;\r\n  private tagEvent: TagCallback;\r\n  private done: Done;\r\n  private readDuration: boolean;\r\n  private fileSize: GetFileSize;\r\n  private frameSyncByte2: number;\r\n\r\n  private calculateVbrDuration: boolean = false;\r\n\r\n  public constructor(headerSize: number) {\r\n    this.headerSize = headerSize;\r\n  }\r\n\r\n  public parse(stream: NodeJS.ReadableStream, tagEvent: TagCallback, done: Done, readDuration?: boolean, fileSize?: GetFileSize) {\r\n\r\n    this.stream = stream;\r\n    this.tagEvent = tagEvent;\r\n    this.done = done;\r\n    this.readDuration = readDuration;\r\n    this.fileSize = fileSize;\r\n\r\n    this.state = State.mpegSearchSync1;\r\n\r\n    strtok.parse(stream, (v, cb) => {\r\n      try {\r\n        return this.strParse(v, cb)\r\n      } catch (error) {\r\n        return done(error);\r\n      }\r\n    });\r\n  }\r\n\r\n  public end(callback: TagCallback, done: Done) {\r\n    if (this.calculateVbrDuration) {\r\n      this.tagEvent('format', 'duration', this.audioFrameHeader.calcDuration(this.frameCount));\r\n    }\r\n    return done();\r\n  }\r\n\r\n  private strParse(v, cb) {\r\n    if (v === undefined) {\r\n      return strtok.UINT8;\r\n    }\r\n\r\n    switch (this.state) {\r\n\r\n      case State.mpegSearchSync1:\r\n        this.state = v === MpegFrameHeader.SyncByte1 ? State.mpegSearchSync2 : State.mpegSearchSync1;\r\n        return strtok.UINT8;\r\n\r\n      case State.mpegSearchSync2:\r\n        if ((v & 0xE0) === 0xE0) {\r\n          // Synchronized\r\n          this.state = State.audio_frame_header;\r\n          this.frameSyncByte2 = v;\r\n          return new strtok.BufferType(2);\r\n        } else {\r\n          this.state = State.mpegSearchSync1;\r\n          return strtok.UINT8;\r\n        }\r\n\r\n      /* falls through */\r\n      case State.audio_frame_header: // audio frame header\r\n\r\n        // we have found the mm tag at the end of the file, ignore\r\n        /*\r\n         if (v.slice(0, 3).toString() === 'TAG') {\r\n         return done()\r\n         }*/\r\n        let buf_frame_header = new Buffer(4);\r\n        v.copy(buf_frame_header, 2);\r\n        buf_frame_header[0] = MpegFrameHeader.SyncByte1;\r\n        buf_frame_header[1] = this.frameSyncByte2;\r\n        let header = MpegAudioLayer.FrameHeader.get(buf_frame_header, 0);\r\n\r\n        if (header.version === null || header.layer === null) {\r\n          return this.seekFirstAudioFrame();\r\n        }\r\n\r\n        // mp3 files are only found in MPEG1/2 Layer 3\r\n        if (( header.version !== 1 && header.version !== 2) || header.layer !== 3) {\r\n          return this.seekFirstAudioFrame();\r\n        }\r\n\r\n        if (header.bitrate == null) {\r\n          return this.seekFirstAudioFrame();\r\n        }\r\n\r\n        if (header.samplingRate == null) {\r\n          return this.seekFirstAudioFrame();\r\n        }\r\n\r\n        this.tagEvent('format', 'dataformat', 'mp3');\r\n        this.tagEvent('format', 'lossless', false);\r\n        this.tagEvent('format', 'bitrate', header.bitrate);\r\n        this.tagEvent('format', 'sampleRate', header.samplingRate);\r\n        this.tagEvent('format', 'numberOfChannels', header.channelMode === 'mono' ? 1 : 2);\r\n\r\n        let slot_size = header.calcSlotSize();\r\n        if (slot_size == null) {\r\n          this.done(new Error('invalid slot_size'));\r\n        }\r\n\r\n        let samples_per_frame = header.calcSamplesPerFrame();\r\n        let bps = samples_per_frame / 8.0;\r\n        let fsize = (bps * header.bitrate / header.samplingRate) +\r\n          ((header.padding) ? slot_size : 0);\r\n        this.frame_size = Math.floor(fsize);\r\n\r\n        this.audioFrameHeader = header;\r\n        this.frameCount++;\r\n        this.bitrates.push(header.bitrate);\r\n\r\n        // xtra header only exists in first frame\r\n        if (this.frameCount === 1) {\r\n          this.offset = MpegAudioLayer.FrameHeader.len;\r\n          return this.skipSideInformation(header);\r\n        }\r\n\r\n        if (this.fileSize && this.frameCount === 3) {\r\n          // the stream is CBR if the first 3 frame bitrates are the same\r\n          if (this.areAllSame(this.bitrates)) {\r\n            this.fileSize((size) => {\r\n              // subtract non audio stream data from duration calculation\r\n              size = size - this.headerSize;\r\n              this.tagEvent('format', 'duration', (size * 8) / header.bitrate);\r\n              // cb(done())\r\n              return this.done();\r\n            });\r\n            return strtok.DEFER;\r\n          } else if (!this.readDuration) {\r\n            return this.done();\r\n          }\r\n        }\r\n\r\n        // once we know the file is VBR attach listener to end of\r\n        // stream so we can do the duration calculation when we\r\n        // have counted all the frames\r\n        if (this.readDuration && this.frameCount === 4) {\r\n          return this.calculateVbrDuration = true;\r\n        }\r\n\r\n        this.offset = 4;\r\n        if (header.isProtectedByCRC) {\r\n          this.state = State.CRC;\r\n          return strtok.INT16_BE;\r\n        } else {\r\n          return this.skipSideInformation(header);\r\n        }\r\n\r\n      case State.CRC:\r\n        this.offset += 2;\r\n        this.crc = v;\r\n        return this.skipSideInformation(this.audioFrameHeader);\r\n\r\n      case State.side_information: // side information\r\n        this.offset += MpegAudioLayer.InfoTag.len;  // 12\r\n        this.state = State.xtra_info_header;\r\n        return MpegAudioLayer.InfoTag;\r\n\r\n      case State.xtra_info_header: // xtra / info header\r\n        this.state = State.skip_frame_data;\r\n        let frameDataLeft = this.frame_size - this.offset;\r\n\r\n        let codecProfile: string;\r\n        switch (v.headerTag) {\r\n          case 'Info':\r\n            codecProfile = 'CBR';\r\n            break;\r\n          case 'Xing':\r\n            codecProfile = MpegAudioLayer.getVbrCodecProfile(v.vbrScale);\r\n            break;\r\n          case 'Xtra':\r\n            // ToDo: ???\r\n            break;\r\n          default:\r\n            return new strtok.IgnoreType(frameDataLeft);\r\n        }\r\n\r\n        this.tagEvent('format', 'encoder', v.encoder);\r\n        this.tagEvent('format', 'codecProfile', codecProfile);\r\n\r\n        // frames field is not present\r\n        if ((v.headerFlags[3] & 0x01) !== 1) {\r\n          return new strtok.IgnoreType(frameDataLeft);\r\n        }\r\n\r\n        this.tagEvent('format', 'duration', this.audioFrameHeader.calcDuration(v.numFrames));\r\n        return this.done();\r\n\r\n      case State.skip_frame_data: // skip frame data\r\n        this.state = State.mpegSearchSync1;\r\n        return strtok.UINT8;\r\n\r\n      default:\r\n        this.done(new Error('Undefined state: ' + this.state));\r\n    }\r\n  }\r\n\r\n  private skipSideInformation(header: MpegFrameHeader) {\r\n    let sideinfo_length = header.calculateSideInfoLength();\r\n\r\n    this.offset += sideinfo_length;\r\n    this.state = State.side_information;\r\n    return new strtok.BufferType(sideinfo_length);\r\n  }\r\n\r\n  private seekFirstAudioFrame(): Token {\r\n    if (this.frameCount > 0) {\r\n      return this.done(new Error('expected frame header but was not found'));\r\n    }\r\n    this.state = State.mpegSearchSync1;\r\n    return strtok.UINT8;\r\n  }\r\n\r\n  private areAllSame(array) {\r\n    let first = array[0];\r\n    return array.every((element) => {\r\n      return element === first;\r\n    });\r\n  }\r\n}\r\n"]}