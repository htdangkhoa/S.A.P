{"version":3,"file":"id3v1.js","sourceRoot":"","sources":["../../src/id3v1.ts"],"names":[],"mappings":"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","sourcesContent":["'use strict';\r\nimport * as strtok from 'strtok2';\r\nimport common from './common';\r\nimport {MpegParser} from './mpeg';\r\nimport {Done, IStreamParser, TagCallback} from './parser';\r\n\r\nclass Id3v1Parser implements IStreamParser {\r\n\r\n  public static getInstance(): Id3v1Parser {\r\n    return new Id3v1Parser();\r\n  }\r\n\r\n  private static parseTag(buf: Buffer, offset: number, end: number, type, tag, callback: TagCallback): void {\r\n    let value = buf.toString('ascii', offset, end);\r\n    value = value.trim().replace(/\\x00/g, '');\r\n    if ( value.length > 0) {\r\n      callback(type, tag, value);\r\n    }\r\n  }\r\n\r\n  private endData: Buffer;\r\n  private type = 'id3v1.1';\r\n  private mpegParser: MpegParser;\r\n\r\n  public parse(stream, callback: TagCallback, done, readDuration?, fileSize?) {\r\n\r\n    let mp3Done = false;\r\n    let id3Done = false;\r\n\r\n    stream.on('data', (data) => {\r\n      this.endData = data;\r\n    });\r\n\r\n    this.mpegParser = new MpegParser(128);\r\n    this.mpegParser.parse(stream, callback, (err) => {\r\n        mp3Done = true;\r\n        if (id3Done) {\r\n          return done(err);\r\n        } else return strtok.DONE;\r\n      }, readDuration, fileSize);\r\n  }\r\n\r\n  public end (callback: TagCallback, done: Done) {\r\n\r\n    let offset = this.endData.length - 128;\r\n    let header = this.endData.toString('ascii', offset, offset += 3);\r\n    if (header !== 'TAG') {\r\n      return done(new Error('Could not find metadata header'));\r\n    }\r\n\r\n    callback('format', 'headerType', this.type);\r\n\r\n    Id3v1Parser.parseTag(this.endData, offset, offset += 30, this.type, 'title', callback);\r\n    Id3v1Parser.parseTag(this.endData, offset, offset += 30, this.type, 'artist', callback);\r\n    Id3v1Parser.parseTag(this.endData, offset, offset += 30, this.type, 'album', callback);\r\n    Id3v1Parser.parseTag(this.endData, offset, offset += 4, this.type, 'year', callback);\r\n    Id3v1Parser.parseTag(this.endData, offset, offset += 28, this.type, 'comment', callback);\r\n\r\n    let track = this.endData[this.endData.length - 2];\r\n    callback(this.type, 'track', track);\r\n\r\n    if (this.endData[this.endData.length - 1] in common.GENRES) {\r\n      let genre = common.GENRES[this.endData[this.endData.length - 1]];\r\n      callback(this.type, 'genre', genre);\r\n    }\r\n\r\n    if (this.mpegParser) {\r\n      this.mpegParser.end(callback, done);\r\n    }\r\n  }\r\n}\r\n\r\nmodule.exports = Id3v1Parser.getInstance();\r\n"]}